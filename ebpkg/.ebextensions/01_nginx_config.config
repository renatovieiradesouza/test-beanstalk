files:
  "/etc/nginx/conf.d/app.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # removed upstream; use direct proxy_pass

      server {
          listen 80 default_server;
          server_name _;

          location ^~ /.well-known/acme-challenge/ {
              root /var/www/letsencrypt;
              default_type text/plain;
              add_header Cache-Control "no-store";
          }

          location / {
              proxy_pass http://127.0.0.1:8080;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }
      }

      server {
          listen 80;
          server_name girus.pipastudios.com;

          location ^~ /.well-known/acme-challenge/ {
              root /var/www/letsencrypt;
              default_type text/plain;
              add_header Cache-Control "no-store";
          }

          location / {
              proxy_pass http://app_upstream;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }
      }

  "/etc/nginx/conf.d/elasticbeanstalk/00_app.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      server { listen 80 default_server; server_name _; location ^~ /.well-known/acme-challenge/ { root /var/www/letsencrypt; default_type text/plain; add_header Cache-Control "no-store"; } location / { proxy_pass http://127.0.0.1:8080; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }
      server { listen 80; server_name girus.pipastudios.com; location ^~ /.well-known/acme-challenge/ { root /var/www/letsencrypt; default_type text/plain; add_header Cache-Control "no-store"; } location / { proxy_pass http://127.0.0.1:8080; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; } }

commands:
  00_remove_ssl_conf:
    command: "rm -f /etc/nginx/conf.d/ssl_app.conf || true"
    ignoreErrors: true
  01_reload_nginx:
    command: "service nginx reload || systemctl reload nginx"
    ignoreErrors: true

